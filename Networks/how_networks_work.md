# How Networks Work #
1. Network structure, it's basic components, how they are used in practice with the help of VMs and libvirt/KVM

## OSI Model ##
1. [OSI Model](https://en.wikipedia.org/wiki/OSI_model)
	1. The model standardizes communication between network protocols
	2. Divides communication into 7 layers
		1. Each layer has it's own set of protocols
2. 7 Layers:
	1. Physical layer
	2. Data Link layer
	3. Network layer
	4. Transport layer
	5. Session layer
	6. Presentation layer
	7. Application layer

### Physical Layer ###
1. Protocols are responsible for hardware communication on lowest level
	1. Transmission of data by wire (or wireless) is described in the layer
	2. Examples:
		1. Wi-Fi
		2. Bluetooth
		3. DSL

### Data Link Layer ###
1. Responsible for transmission of data between two devices in one network
	1. Transmitted in frames
		1. Frame: contains physical address of sender and receiver
			1. MAC-address
	2. Who are sender and receiver?
		1. Every device has NIC (Network Interface Controller)
			1. It is hardware (or virtual hardware) responsible from sending and receiving frames
			2. NIC has a MAC address
				1. MAC address - unique address embedded in hardware or generated by Virtual system
			3. A machine can have multiple NICs
	3. How to check NICs in a system?
		1. `ip link show` **(M)**
	4. Interface for communicating is eth0
		1. MAC address: 52:54:00:05:36:e6
		2. `lo`? loopback device
			1. It is a virtual interface which is used by system to communicate with itself
				1. Local apps can communicate with each other without internet
2. Other connecting devices:
	1. Switch
		1. It builds up a network
			1. All machines are connected to it via ports
				1. L2 switch (more advanced ones exist - L3 and L7)
					1. It forwards frames to MAC sender to MAC receiver
		2. Devices connected to a switch form a LAN (Local Area Network)
			1. [LAN](https://en.wikipedia.org/wiki/Local_area_network)
		3. Used to connect servers located physically in the same place
			1. All the servers will belong to the same network
	2. VLAN (virtual local area network):
		1. Can be implemented using switch
			1. VLAN-tag is added to frame
				1. It determines which network of the frame it belongs to
	3. Bridge:
		1. L2 bridge - used to connect two networks (formed using switches)
			1. Switches, bridges and hubs connect multiple devices together into one network
	4. Routers:
		1. Work on L3
			1. Wi-Fi router connects local area network (which has laptop, mobile phone, tablet) with the internet
3. WAN: Wide Area Network
	1. Internet is a WAN but erases geographical boundaries of network
		1. [L3 switches](https://dougvitale.wordpress.com/2012/12/01/layer-3-switches-compared-to-routers/) may have routing capabilities

### Network Layer ###
1. On third network layer: IP addresses are used instead of MAC addresses
	1. `ip addr show` **(M)**
		1. IP address assigned to eth0
			1. `/24`: Internet is many networks together
				1. Each network has a [separate block of IP addresses](https://en.wikipedia.org/wiki/Reserved_IP_addresses)
					1. Example private networks not accessible from outside
			2. CIDR: A method to allocate IP addresses for networks
				1. Notation: 192.168.122.212/24
					1. `/24`: Mask - defines how many addresses are in the block
						1. IP addresses go from 0.0.0.0 to 255.255.255.255 (32 bits number)
						2. Mask: 255.255.255.0
						3. Finding first and last address of the network:
							1. Do bitwise AND of one of the addresses and the mask

									11000000.10101000.01111010.11010100
									&
									11111111.11111111.11111111.00000000
									=
									11000000.10101000.01111010.00000000

								1. 192.168.122.0 is starting address of the network
								2. 192.168.122.255 is ending address of the network
									1. 255 addresses in total [calculator](https://www.iplocation.net/subnet-calculator)

### ARP ###
1. [ARP (Address Resolution Protocol)](https://en.wikipedia.org/wiki/Address_Resolution_Protocol) - A mechanism that associates MAC-address with IP-address
	1. `arp -n` table of MAC addresses and IP addresses mapped to them
		1. `ip neigh` is preferred
	2. Cyber attack: [ARP spoofing](https://en.wikipedia.org/wiki/ARP_spoofing)
		1. Replaces MAC-address with hacker's device address

### DHCP ###
1. Two options for assigning IP address
	1. Manual: hadwork (there may be conflicts)
	2. Dynamic Host Configuration Protocol ([DHCP](https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol))
		1. Protocol for setting different configurations including IP-addresses automatically
	3. DHCP server: assigns IP-addresses
		1. At home DHCP server is located in router
	4. DHCP client: On the device - requests for an address
		1. DHCP client is located in each device
2. How does DHCP work?
	1. [broadcasting](https://en.wikipedia.org/wiki/Broadcasting_%28networking%29)
		1. Process by which server transfers a message to all servers in network as it doesn't know where exactly the info it needs is located
	2. Steps:
		1. A DHCP-client sends a bradcast message with a request "I need an IP-address"
			1. Sender field of packet is set to 0.0.0.0 and UDP port 68 (reserved for DHCP clients)
			2. Receiver field of packet is set to 255.255.255.255, UDP port 67 (reserved for DHCP servers)
				1. Broadcasts to everyone in the network
		2. A DHCP-server catches it and sends back a broadcast message "I have an IP-address x.x.x.x, do you want it? (for certain amount of time)"
			1. We don't know how to find the host
			2. IP sender - 192.168.1.1, UDP port 67
			3. IP receiver - 255.255.255.255, UDP port 68 - broadcast
		3. The DHCP-client receives the message and sends another one: "Yes, I want the address x.x.x.x"
			1. IP sender 0.0.0.0, UDP port 68
			2. IP receiver: 255.255.255.255, UDP port 67 - broadcast
		4. The DHCP-server answers "OK, then x.x.x.x belongs to you"
			1. IP sender: 192.168.1.1, UDP port 67
			2. IP receiver: 255.255.255.255, UDP port 68 - broadcast
	3. Video:
		1. [https://www.youtube.com/watch?v=RUZohsAxPxQ](https://www.youtube.com/watch?v=RUZohsAxPxQ)
			1. If multiple servers can respond with an address offer
				1. New host chooses one offer
				1. Servers see which offer the client picked
			2. Two hosts can ask for an address simultaneously
				1. Can be distinguished using **transaction ID**
			3. Addresses are valid for a limited time
				1. This mechanism is used to re-cycle the un-used IP addresses so that others can use them again
				2. Hosts can prevent the server from taking away the IP addresses by renewing the lease
	4. Where are the connection settings stored?
		1. `/etc/sysconfig/network-scripts` **(M)**
			1. We can edit the way IP-address is assigned (static or automatic)
			2. Whether to start connection automatically when system loads or not
		2. Example:

				HWADDR=4C:34:88:54:C1:2B
				ESSID="FRITX!Box 7490"
				MODE=Managed
				KEY_MGMT=WPA-PSK
				TYPE=Wireless
				BOOTPROTO=dhcp
				DEFROUTE=yes
				IPV4_FAILURE_FATAL=no
				IPV6INIT=yes
				IPV6_AUTOCONF=yes
				IPV6_DEFROUTE=yes
				IPV6_FAILURE_FATAL=no
				NAME="FRITZ!Box 7490"
				UUID=55ba9218-1d2f-407d-af13-51502d542edb
				ONBOOT=yes
				SECURITYMODE=open
				PEERDNS=yes
				PEERROUTES=yes
				IPV6_PEERDNS=yes
				IPV6_PEERROUTES=yes

			1. `BOOTPROTO=dhcp` - says that the device uses DHCP to receive IP address
		3. Example - for loopback device

				DEVICE=lo
				IPADDR=127.0.0.1
				NETMASK=255.0.0.0
				NETWORK=127.0.0.0
				# If you're having problems with gated making 127.0.0.0/8 a martian,
				# you can change this to something else (255.255.255.255, for example)
				BROADCAST=127.255.255.255
				ONBOOT=yes
				NAME=loopback

			1. `IPADDR=127.0.0.1` - static address
		3. `nmcli` or `Networkmanager-tui` package for friendly text interface to modify the settings
			1. On servers: use system of configuration (Puppet, Chef, Salt)
	5. Routing: Where will the traffic flow?
		1. `ip_r` command - mobile phone can be a router
			1. Traffic goes to the router
				1. `ip addr show` - the device should have an IP from the network
		2. `ip r add` - used to add new paths
		3. `ip r del` - used to delete paths

### DNS ###
1. BIND - popular DNS-server
	1. It stores information about addresses and responds to requests
	2. Recommended to deploy locally
	3. [Cisco DNS Best Practices, Network Protections, and Attack Identification](http://www.cisco.com/c/en/us/about/security-center/dns-best-practices.html)
		1. Useful recommendations on safe and sustainable DNS-server
	4. `nsupdate` - automatically updates DNS-server records
		1. Guide on configuration
			1. Service discovery
2. Before DNS was introduced, `/etc/hosts` file existed
	1. `/etc/nsswitch.conf` - in what order and where to look for information (includes where to look for hosts)
		1. Default: `/etc/hosts`
		2. Then: request is sent to DNS-server
	2. `/etc/resolv.conf` - defines server used for resolving DNS-names
3. DNS problems can be debugged using the following commands:
	1. `dig`
	2. `nslookup`
		1. To request information from nameserver 8.8.8.8 about mkdev.me

				dig mkdev.me 8.8.8.8

### Virtual Machines ###
1. Installing VM:

		sudo virt-install --name mkdev-networking-basics-1 \
		--location ~/Downloads/CentOS-7-x86_64-Minimal-1511.iso \
		--initrd-inject /path/to/ks.cfg \
		--extra-args ks=file:/ks.cfg \
		--memory=1024 --vcpus=1 --disk size=8

2. `libvirt` constructs one network by default

		virsh net-list

	1. Block `192.168.0.0/16` is allocated for private networks
	2. `libvirt` has allocated `192.168.122.212/24` for its network
		1. All addresses from 192.168.122.0 to 192.168.122.255 are part of the network
	3. Getting more information about a network

			virsh net-dumpxml default

			<network connections='1'>
			  <name>default</name>
			  <uuid>f2ee9249-6bed-451f-a248-9cd223a80702</uuid>
			  <forward mode='nat'>
			    <nat>
			      <port start='1024' end='65535'/>
			    </nat>
			  </forward>
			  <bridge name='virbr0' stp='on' delay='0'/>
			  <mac address='52:54:00:83:b4:74'/>
			  <ip address='192.168.122.1' netmask='255.255.255.0'>
			    <dhcp>
			      <range start='192.168.122.2' end='192.168.122.254'/>
			    </dhcp>
			  </ip>
			</network>

		1. `connections` - number of machines connected to the network
	4. [libvirt documentation](https://libvirt.org/formatnetwork.html)
		1. Options of XML-file
3. `bridge` or `virbr0` - device or virtual network switch
	1. All VMs in the network are connected to it
	2. All requests from one VM to another within this network go through this virtual switch
	3. `Libvirt` defines a virtual switch for each network
		1. Every switch is recognized as separate device on host machine
		2. Network creation in `libvirt` is defining a virtual switch that all VMs are connected to
			1. This defines a LAN
	4. `virbr0` is implemented using [Linux Bridge](https://wiki.archlinux.org/index.php/Network_bridge)
		1. Technology for virtual local area networks
		2. List switches using `brctl show` on host machine
		3. It is an L3 switch and has features like [traffic filtering and firewall](http://www.linuxfoundation.org/collaborate/workgroups/networking/bridge)
	5. Example:

			<ip address='192.168.122.1' netmask='255.255.255.0'>
				<dhcp>
					<range start='192.168.122.2' end='192.168.122.254'/>
				</dhcp>
			</ip>

		1. Block of addresses used for VMs is 192.168.122.1 (host-machine ip within the Virtual Network)

				ip r

		2. Traffic from VM goes outside through host machine
	6. [dnsmasq](http://www.thekelleys.org.uk/dnsmasq/doc.html) - Libvirt uses it for DHCP and DNS

				ps aux | grep dns

	7. DHCP table - shows un-assigned addresses (as well)

			virsh net-dhcp-leases default
			
		1. Shows VM's MAC-addrss of `eth0`

### NAT ###
1. The total number of IP-addresses isn't going to increase
	1. A combination of private and public addresses is always used
	2. Public address hides a lot of machines (each machine having it's own private address)

### tcpdump ###
### VPN ###
### For Self Study ###
### What's Next? ###
### Further Reading ###
